---
phase: 04-pwa-web-share-target
plan: 04
type: execute
wave: 3
depends_on:
  - 04-01
  - 04-03
files_modified: []
autonomous: false
requirements:
  - IMPT-01
  - PWA-01
  - PWA-02
  - PWA-03

must_haves:
  truths:
    - "Chrome DevTools Application tab shows the app as installable (no 'Install' button grayed out)"
    - "After installation, the app loads fully with no network connection"
    - "On Android Chrome, sharing a URL from another app opens RSVP Reader and extracts article text"
    - "On any platform, manually entering a URL in EntryScreen extracts article text and shows preview"
    - "CORS-blocked URL shows an explanatory error message with a paste fallback button"
    - "After importing any document, closing and reopening the app shows the last document loaded"
    - "iOS users can import PDFs via file picker and paste text without degradation"
  artifacts:
    - path: "dist/sw.js"
      provides: "Compiled Workbox app-shell service worker"
      contains: "precacheAndRoute"
    - path: "dist/icons/pwa-192x192.png"
      provides: "Required PNG icon for Chrome installability"
    - path: "dist/manifest.json"
      provides: "PWA manifest with valid icons and share_target"
  key_links:
    - from: "Browser install prompt"
      to: "manifest.json + icons + HTTPS"
      via: "Chrome installability criteria"
      pattern: "192x192"
    - from: "Service worker"
      to: "WASM bundle"
      via: "Workbox precache includes .wasm files"
      pattern: "wasm"
---

<objective>
Human verification of all four Phase 4 requirements: PWA installability (PWA-01), offline capability (PWA-02), URL share target flow (IMPT-01), and iOS fallback (PWA-03).

Purpose: PWA features require real device or browser testing — Lighthouse audits, actual install prompts, offline network throttling, and Android share sheet behavior cannot be fully verified from code alone.

Output: Human-confirmed sign-off that all four Phase 4 success criteria pass.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build production bundle and run automated PWA checks</name>
  <files></files>
  <action>
Run production build and automated verification:

```bash
nvm use 22 && npm run build
```

Verify build artifacts exist:
```bash
ls dist/sw.js
ls dist/icons/pwa-192x192.png dist/icons/pwa-512x512.png dist/icons/maskable-icon-512x512.png
cat dist/manifest.json | python3 -m json.tool
```

Check the Workbox SW includes WASM files in precache:
```bash
grep -c "wasm" dist/sw.js
```
Should return > 0 (the WASM bundle hash is embedded in the precache manifest).

Check the compiled manifest has correct icon paths (not vite.svg):
```bash
grep "pwa-192x192" dist/manifest.json && echo "ICONS OK"
grep "maskable" dist/manifest.json && echo "MASKABLE OK"
```

Check that /load-url route exists in compiled app:
```bash
grep -r "load-url" dist/assets/*.js | head -3 && echo "ROUTE OK"
```

Serve the production build locally for human testing:
```bash
npm run preview
```

The preview server runs at http://localhost:4173. Report the URL and all automated check results to the user.
  </action>
  <verify>
    <automated>cd /workspace && nvm use 22 2>/dev/null; npm run build 2>&1 | tail -5 && ls dist/sw.js && grep -c "wasm" dist/sw.js && grep "pwa-192x192" dist/manifest.json && echo "AUTOMATED CHECKS PASSED"</automated>
    <manual>Check all grep outputs above confirm: sw.js exists, WASM in precache, PNG icons in manifest.</manual>
  </verify>
  <done>Build exits 0. dist/sw.js exists with WASM references. dist/manifest.json has PNG icons and share_target. Preview server running at localhost:4173.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification — PWA installability, offline, URL extraction, iOS fallback</name>
  <action>Human verifies all Phase 4 requirements against the running preview server at http://localhost:4173.</action>
  <verify>
    <manual>
Test these flows at http://localhost:4173 (or your deployed HTTPS URL — PWA install requires HTTPS):

**Test 1 — PWA Installability (PWA-01):**
1. Open Chrome DevTools → Application tab → Manifest
2. Verify: Name "RSVP Reader", icons show as PNG (not SVG placeholder), no manifest errors
3. Open DevTools → Application → Service Workers — confirm the app-shell SW is registered
4. On Chrome desktop: look for the install icon in the address bar. Click it to install.
5. Expected: App installs and opens as standalone window (no browser address bar)

**Test 2 — Offline capability (PWA-02):**
1. Import a document (PDF or paste text) — this persists it to IndexedDB
2. In Chrome DevTools → Network → set to "Offline"
3. Refresh the page
4. Expected: App loads fully (no network error). Last imported document available.
5. Re-enable network when done

**Test 3 — URL extraction flow (IMPT-01):**
1. Click "Or enter a URL" in EntryScreen
2. Enter a CORS-accessible URL (e.g. https://en.m.wikipedia.org/wiki/Speed_reading or a raw GitHub README URL)
3. Expected: UrlLoader screen shows hostname ("Fetching article from ..."), then navigates to /preview with extracted text
4. Enter a CORS-blocked URL (e.g. https://www.nytimes.com)
5. Expected: Error message explaining CORS block, with "Go back and paste instead" button

**Test 4 — iOS fallback path (PWA-03):**
1. Verify EntryScreen shows: file picker button, "Or enter a URL" accordion, "Or paste text" section
2. Verify file picker button opens the native file picker
3. Verify paste text section accepts text and navigates to preview
4. Expected: All three import paths work normally

**Test 5 — Document persistence across restart (PWA-02 offline scope):**
1. Import a PDF or paste text, navigate to /read
2. Close the browser tab entirely and reopen the app
3. Expected: DocumentHydrator restores the last document so it is available without re-importing
    </manual>
  </verify>
  <done>Human approves all five test scenarios: installability, offline load, URL extraction, CORS error, iOS fallback paths, and document persistence across tab close.</done>
  <what-built>
Complete Phase 4 PWA implementation:
- Plan 01: Workbox app-shell service worker (dist/sw.js), PNG icons, updated manifest
- Plan 02: URL extractor (@mozilla/readability), document persistence (idb-keyval), UrlLoader component
- Plan 03: /load-url route, URL share detection in App.tsx, DocumentHydrator, EntryScreen URL input, persistDocument calls
  </what-built>
  <how-to-verify>See Test 1–5 in the manual verify section above.</how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found for Claude to fix.</resume-signal>
</task>

</tasks>

<verification>
All four Phase 4 requirements verified by human:
- PWA-01: Installable — install prompt appears in Chrome, app installs as standalone
- PWA-02: Offline — app shell loads offline after installation; last document persisted and available
- IMPT-01: URL share target — URL extraction works, CORS failure shows actionable error
- PWA-03: iOS fallback — file picker + paste + manual URL input all function on any browser
</verification>

<success_criteria>
Human approves all five test scenarios:
1. PWA installability confirmed in Chrome DevTools and via install prompt
2. App loads offline after installation with last document available
3. URL extraction extracts article from a CORS-accessible URL and shows preview
4. CORS-blocked URL shows explanatory error with paste fallback
5. iOS import paths (file picker, paste, manual URL) all work without regression
</success_criteria>

<output>
After completion, create `.planning/phases/04-pwa-web-share-target/04-04-SUMMARY.md`
</output>
