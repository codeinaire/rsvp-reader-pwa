---
phase: 04-pwa-web-share-target
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - vite.config.ts
  - src/sw.ts
  - public/manifest.json
  - public/logo.svg
autonomous: true
requirements:
  - PWA-01
  - PWA-02

must_haves:
  truths:
    - "The app passes Lighthouse installability check (192px + 512px PNG icons present, manifest valid)"
    - "After build, dist/ contains a compiled service worker (sw.js) with Workbox precache entries"
    - "The WASM bundle (.wasm file) is included in the Workbox precache manifest"
    - "The app shell service worker is registered at root scope (not /share-target/)"
    - "manifest.json references real PNG icon files, not vite.svg placeholder"
    - "The share_target POST entry includes title/text/url params alongside files so URL shares also arrive via the same action"
  artifacts:
    - path: "src/sw.ts"
      provides: "Workbox app-shell service worker source"
      contains: "precacheAndRoute(self.__WB_MANIFEST)"
    - path: "public/logo.svg"
      provides: "RSVP Reader brand SVG for icon generation"
      min_lines: 5
    - path: "public/manifest.json"
      provides: "Updated PWA manifest with real icon paths and extended share_target"
      contains: "pwa-192x192.png"
  key_links:
    - from: "vite.config.ts"
      to: "src/sw.ts"
      via: "VitePWA injectManifest srcDir+filename config"
      pattern: "injectManifest"
    - from: "src/sw.ts"
      to: "self.__WB_MANIFEST"
      via: "workbox-precaching precacheAndRoute"
      pattern: "precacheAndRoute"
    - from: "public/manifest.json"
      to: "public/icons/pwa-192x192.png"
      via: "icons array src field"
      pattern: "pwa-192x192"
---

<objective>
Install vite-plugin-pwa, create the Workbox app-shell service worker (src/sw.ts), generate real PNG icons from an SVG logo, and update the manifest with proper icon paths and extended share_target params.

Purpose: This is the PWA foundation. Without a valid app-shell SW and proper PNG icons, Chrome will not show the install prompt (PWA-01 fails) and the app will not work offline (PWA-02 fails).

Output: A production build that includes a Workbox-managed SW precaching all assets (including WASM), manifest.json referencing real 192px/512px/maskable PNGs, and the share_target extended to receive URL/text shares in addition to PDF files.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pwa-web-share-target/04-RESEARCH.md
@.planning/phases/03-import-ui-reading-view/03-02-SUMMARY.md
@vite.config.ts
@public/manifest.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install vite-plugin-pwa, create src/sw.ts app-shell SW, and update vite.config.ts</name>
  <files>
    package.json
    vite.config.ts
    src/sw.ts
  </files>
  <action>
Install dependencies:
```
npm install -D vite-plugin-pwa workbox-build
npm install -D @vite-pwa/assets-generator
```

Create `src/sw.ts` — the Workbox app-shell service worker (injectManifest strategy). This SW is registered at root scope by vite-plugin-pwa and is SEPARATE from `public/share-target-sw.js` (which stays unchanged at /share-target/ scope):

```typescript
import { cleanupOutdatedCaches, precacheAndRoute } from 'workbox-precaching'

declare let self: ServiceWorkerGlobalScope

// Remove caches from outdated versions
cleanupOutdatedCaches()

// Precache all app assets injected by vite-plugin-pwa at build time.
// Includes JS chunks, CSS, HTML, SVGs, and WASM files (configured in vite.config.ts).
// No skipWaiting() — per project decision, new SW waits until all tabs close before activating.
precacheAndRoute(self.__WB_MANIFEST)
```

Update `vite.config.ts` to add VitePWA plugin. Import `VitePWA` from `'vite-plugin-pwa'`. Add it as the LAST plugin after `tailwindcss()`. The existing react(), wasm(), tailwindcss() and all worker config remain unchanged:

```typescript
VitePWA({
  strategies: 'injectManifest',
  srcDir: 'src',
  filename: 'sw.ts',
  // Use project-managed public/manifest.json — do NOT auto-generate a new one
  manifest: false,
  injectManifest: {
    // CRITICAL: include .wasm so the WASM bundle is pre-cached at install time
    globPatterns: ['**/*.{js,css,html,svg,wasm}'],
  },
  // 'prompt' = new SW waits until all tabs close before activating (no skipWaiting)
  registerType: 'prompt',
  // Register the app-shell SW automatically in the app bundle
  injectRegister: 'auto',
  devOptions: {
    enabled: false,
  },
}),
```

Do NOT add `workbox-precaching` or `workbox-routing` to imports in the main app — they are only needed in `src/sw.ts` itself.

Verify: `npm run build` exits 0 and `dist/sw.js` exists with Workbox precache entries.
  </action>
  <verify>
    <automated>cd /workspace && nvm use 22 2>/dev/null; npm run build 2>&1 | tail -20 && ls dist/sw.js && echo "BUILD OK"</automated>
    <manual>Check that dist/sw.js exists and contains workbox precache entries.</manual>
  </verify>
  <done>Build exits 0, dist/sw.js exists, no TypeScript errors from src/sw.ts.</done>
</task>

<task type="auto">
  <name>Task 2: Create SVG logo, generate PNG icons, and update manifest with icon paths + extended share_target</name>
  <files>
    public/logo.svg
    public/icons/pwa-192x192.png
    public/icons/pwa-512x512.png
    public/icons/maskable-icon-512x512.png
    public/manifest.json
  </files>
  <action>
Create `public/logo.svg` — a simple, recognizable RSVP Reader brand icon. Use a dark square background (#030712) with a white letter "R" centered, or an eye/book symbol. Minimum: a valid SVG with viewBox="0 0 512 512", background rect, and a clean symbol. Example:

```svg
&lt;svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"&gt;
  &lt;rect width="512" height="512" rx="96" fill="#030712"/&gt;
  &lt;text x="256" y="340" text-anchor="middle" font-family="Georgia, serif"
        font-size="300" font-weight="bold" fill="#ef4444"&gt;R&lt;/text&gt;
&lt;/svg&gt;
```

Generate PNG icons using @vite-pwa/assets-generator:
```
npx pwa-assets-generator --preset minimal-2023 public/logo.svg
```

This generates files under `public/icons/`:
- `pwa-64x64.png`
- `pwa-192x192.png`
- `pwa-512x512.png`
- `maskable-icon-512x512.png`
- `favicon.ico`

If the CLI doesn't generate to `public/icons/`, check its output and move files accordingly. The manifest expects them at `/icons/pwa-192x192.png` etc.

Update `public/manifest.json`:

1. Replace the `icons` array placeholder (currently uses vite.svg) with real PNG entries:
```json
"icons": [
  {
    "src": "/icons/pwa-192x192.png",
    "sizes": "192x192",
    "type": "image/png",
    "purpose": "any"
  },
  {
    "src": "/icons/pwa-512x512.png",
    "sizes": "512x512",
    "type": "image/png",
    "purpose": "any"
  },
  {
    "src": "/icons/maskable-icon-512x512.png",
    "sizes": "512x512",
    "type": "image/png",
    "purpose": "maskable"
  }
]
```

2. Extend the `share_target` entry to handle BOTH PDF files (existing) AND URL/text shares (new Phase 4). The existing `method: "POST"` and `enctype: "multipart/form-data"` remain. Add `title`, `text`, and `url` params alongside the existing `files` param. The `share-target-sw.js` (unchanged) already passes the full formData — it will distinguish PDF vs URL shares by checking whether `formData.get('pdf')` is non-null. The App.tsx URL handler (Plan 03) reads the GET-style params that Android Chrome encodes in the POST body:

```json
"share_target": {
  "action": "/share-target/",
  "method": "POST",
  "enctype": "multipart/form-data",
  "params": {
    "title": "title",
    "text": "text",
    "url": "url",
    "files": [
      {
        "name": "pdf",
        "accept": ["application/pdf", ".pdf"]
      }
    ]
  }
}
```

NOTE: The Web Share Target spec allows only ONE `share_target` object (not an array). Adding title/text/url params to the POST entry is the correct approach — a single action handles both PDF files and URL/text shares. The service worker distinguishes by checking `formData.get('pdf')`.

After icon generation, run `npm run build` to confirm dist/icons/ has the PNG files in the output.
  </action>
  <verify>
    <automated>cd /workspace && nvm use 22 2>/dev/null; ls public/icons/pwa-192x192.png public/icons/pwa-512x512.png public/icons/maskable-icon-512x512.png && npm run build 2>&1 | tail -10 && ls dist/icons/ && echo "ICONS OK"</automated>
    <manual>Check public/manifest.json references the PNG icon paths and the share_target has title/text/url params.</manual>
  </verify>
  <done>PNG icons exist in public/icons/, manifest.json references them with correct sizes, share_target has title/text/url params alongside files. Build exits 0.</done>
</task>

</tasks>

<verification>
Run `npm run build` — exits 0 with:
- `dist/sw.js` present (Workbox app-shell SW)
- `dist/icons/pwa-192x192.png` and `dist/icons/pwa-512x512.png` present
- `dist/manifest.json` has PNG icons (not vite.svg) and share_target with title/text/url/files params
- No TypeScript errors

Check `dist/sw.js` contains a non-trivial precache manifest (grep for `__WB_MANIFEST` or `precacheAndRoute`).
</verification>

<success_criteria>
- `npm run build` exits 0
- `dist/sw.js` exists and contains Workbox precache logic
- dist/icons/ contains pwa-192x192.png, pwa-512x512.png, maskable-icon-512x512.png
- manifest.json: icons array references .png files; share_target includes title/text/url params
- WASM file appears in Workbox precache list (verified in dist/sw.js or DevTools at runtime)
</success_criteria>

<output>
After completion, create `.planning/phases/04-pwa-web-share-target/04-01-SUMMARY.md`
</output>
