---
phase: 01-wasm-pipeline-document-service
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - vite.config.ts
  - tsconfig.json
  - tsconfig.app.json
  - index.html
  - src/main.tsx
  - src/App.tsx
  - src/index.css
  - rsvp-parser/Cargo.toml
  - rsvp-parser/crates/rsvp-parser/Cargo.toml
  - rsvp-parser/.cargo/config.toml
autonomous: true
requirements:
  - DOCF-01
  - IMPT-04

must_haves:
  truths:
    - "npm run dev starts a Vite 7 dev server with zero errors"
    - "wasm-pack is available (npm-installed devDependency) and rustup target wasm32-unknown-unknown is added"
    - "The Rust workspace compiles with cargo check --target wasm32-unknown-unknown (before adding pdf-extract)"
    - "vite.config.ts has WASM plugins in both plugins and worker.plugins"
    - "Release Cargo profile has opt-level=z, lto=true, codegen-units=1, panic=abort, strip=true"
  artifacts:
    - path: "vite.config.ts"
      provides: "Vite 7 config with wasm, topLevelAwait, tailwindcss, and worker.plugins"
      contains: "worker.plugins"
    - path: "rsvp-parser/Cargo.toml"
      provides: "Rust workspace root with size-optimized release profile"
      contains: "opt-level = \"z\""
    - path: "rsvp-parser/crates/rsvp-parser/Cargo.toml"
      provides: "Parser crate with cdylib + rlib, wasm-bindgen dep, pdf/epub optional features"
      contains: "crate-type"
    - path: "rsvp-parser/.cargo/config.toml"
      provides: "getrandom wasm_js backend rustflag for wasm32-unknown-unknown"
      contains: "getrandom_backend"
  key_links:
    - from: "src/main.tsx"
      to: "src/App.tsx"
      via: "createRoot import — must render immediately, no await before render"
      pattern: "createRoot.*render"
    - from: "vite.config.ts"
      to: "rsvp-parser WASM pkg"
      via: "optimizeDeps.exclude prevents esbuild pre-bundling of .wasm"
      pattern: "optimizeDeps"
---

<objective>
Scaffold the complete project: Vite 7 + React + TypeScript app, Rust WASM workspace, and the Vite config that makes WASM-in-Workers work correctly. This plan creates the buildable skeleton everything else layers onto.

Purpose: Without the correct Vite config (worker.plugins, optimizeDeps.exclude) and Cargo profile (panic=abort, lto=true), WASM either fails at build time or bloats the bundle. These must be right from the start — retrofitting is painful.

Output: A runnable Vite dev server, a Rust workspace that cargo-checks for wasm32, and the directory structure matching the research-specified layout.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-wasm-pipeline-document-service/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Vite 7 + React + TypeScript project with WASM plugins</name>
  <files>
    package.json
    vite.config.ts
    tsconfig.json
    tsconfig.app.json
    index.html
    src/main.tsx
    src/App.tsx
    src/index.css
  </files>
  <action>
From the project root (/Users/nousunio/Repos/Learnings/claude-code/text-to-voice), scaffold the app:

1. Run: `node --version` — confirm Node.js is 20.19+ (Vite 7 requirement). If not, stop and note this blocker.

2. Run: `npm create vite@latest . -- --template react-ts` in the project root (use "." since we're already in the target directory; say yes to overwrite if prompted). This creates package.json, vite.config.ts, tsconfig files, index.html, src/main.tsx, src/App.tsx.

3. Install dependencies:
```bash
npm install
npm install zustand
npm install -D vite-plugin-wasm vite-plugin-top-level-await
npm install -D @tailwindcss/vite
npm install -D wasm-pack
npm install @radix-ui/react-progress
```

4. Rewrite `vite.config.ts` with EXACTLY this content (critical: worker.plugins and optimizeDeps.exclude are non-negotiable):
```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import wasm from 'vite-plugin-wasm'
import topLevelAwait from 'vite-plugin-top-level-await'
import tailwindcss from '@tailwindcss/vite'

export default defineConfig({
  plugins: [
    react(),
    wasm(),
    topLevelAwait(),
    tailwindcss(),
  ],
  worker: {
    // CRITICAL: WASM plugins MUST also be in worker.plugins.
    // Without this, wasm imports inside parser-worker.ts fail at Vite build time.
    plugins: () => [wasm(), topLevelAwait()],
  },
  // Prevent Vite/esbuild from pre-bundling the WASM pkg — it cannot handle .wasm files.
  // If excluded, the .wasm file is served as a separate asset (correct behavior).
  optimizeDeps: {
    exclude: ['rsvp-parser'],
  },
})
```

5. Set up Tailwind CSS v4 (no tailwind.config.js needed — first-party Vite plugin):
Replace the contents of `src/index.css` with:
```css
@import "tailwindcss";
```

6. Update `src/main.tsx` to NOT await anything before render:
```typescript
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.tsx'

// IMPORTANT: Never await WASM init or any async operation before this line.
// documentService starts initializing as a side effect of its import in App.tsx.
// The import button starts disabled and enables when the worker sends Init success.
createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <App />
  </StrictMode>,
)
```

7. Replace `src/App.tsx` with a minimal placeholder (routing and screens added in Plan 04):
```typescript
import React from 'react'

export default function App() {
  return (
    <div className="min-h-screen bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100">
      <p className="p-4 text-sm text-gray-500">RSVP Reader — scaffold</p>
    </div>
  )
}
```

8. Create the directory structure for later plans:
```
src/workers/
src/services/
src/lib/
src/components/EntryScreen/
src/components/TextPreview/
src/components/RSVPPlaceholder/
src/store/
```
Use `mkdir -p` for each.
  </action>
  <verify>
Run `npm run dev` and confirm the dev server starts without errors. Check that the terminal shows a localhost URL. Also verify `node_modules/vite-plugin-wasm` exists and `node_modules/wasm-pack` exists.
  </verify>
  <done>
`npm run dev` starts successfully (exit with Ctrl+C after confirming). `npm run build` may warn about empty entry points — acceptable at this stage. vite.config.ts contains worker.plugins with wasm() and topLevelAwait(). src/index.css contains only `@import "tailwindcss"`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Rust WASM workspace with size-optimized Cargo config</name>
  <files>
    rsvp-parser/Cargo.toml
    rsvp-parser/crates/rsvp-parser/Cargo.toml
    rsvp-parser/crates/rsvp-parser/src/lib.rs
    rsvp-parser/crates/rsvp-parser/src/types.rs
    rsvp-parser/.cargo/config.toml
  </files>
  <action>
1. Add wasm32 target to Rust toolchain:
```bash
rustup target add wasm32-unknown-unknown
```

2. Create workspace directory structure:
```bash
mkdir -p rsvp-parser/crates/rsvp-parser/src
mkdir -p rsvp-parser/.cargo
```

3. Create `rsvp-parser/Cargo.toml` (workspace root with size-optimized release profile):
```toml
[workspace]
members = ["crates/rsvp-parser"]
resolver = "2"

[profile.release]
opt-level = "z"        # Optimize for size — smallest binary (not "s")
lto = true             # Link-time optimization — removes dead code across crates
codegen-units = 1      # Required for full LTO
panic = "abort"        # WASM cannot unwind; saves ~20% binary size
strip = true           # Strip debug symbols

[workspace.lints.clippy]
unwrap_used = "deny"
expect_used = "deny"
panic = "deny"
```

4. Create `rsvp-parser/.cargo/config.toml` (getrandom fix for wasm32 — required for pdf-extract spike):
```toml
[target.wasm32-unknown-unknown]
# getrandom 0.3.x requires explicit configuration for wasm32-unknown-unknown.
# pdf-extract -> lopdf -> getrandom chain needs this flag.
# Without it, wasm-pack build fails with "wasm32-unknown-unknown not supported".
rustflags = ["--cfg", "getrandom_backend=\"wasm_js\""]
```

5. Create `rsvp-parser/crates/rsvp-parser/Cargo.toml`:
```toml
[package]
name = "rsvp-parser"
version = "0.1.0"
edition = "2021"

[lib]
crate-type = ["cdylib", "rlib"]
# cdylib = compiled to .wasm for browser use
# rlib = allows `cargo test` to run (tests need a normal Rust lib)

[package.metadata.wasm-pack.profile.release]
wasm-opt = ["-Oz", "--enable-bulk-memory"]

[dependencies]
wasm-bindgen = "0.2"
serde = { version = "1", features = ["derive"] }
serde-wasm-bindgen = "0.6"

# PDF extraction — optional, gated by feature flag.
# pdf-extract 0.10.0 depends on lopdf 0.38+ with wasm_js feature.
# WASM compilation is unverified (see Phase 1 spike plan).
# If spike fails, replace with pdfium-render.
pdf-extract = { version = "0.10", optional = true }

[features]
default = ["pdf"]
pdf = ["dep:pdf-extract"]
```

6. Create `rsvp-parser/crates/rsvp-parser/src/types.rs`:
```rust
use serde::{Deserialize, Serialize};

/// Result returned from any document parse operation.
/// words: tokenized word array, ready for RSVP display.
/// title: extracted document title, if available.
#[derive(Debug, Serialize, Deserialize)]
pub struct ParseResult {
    pub words: Vec<String>,
    pub title: Option<String>,
}
```

7. Create `rsvp-parser/crates/rsvp-parser/src/lib.rs` (stubs only — no PDF logic yet, that comes in Plan 03 after spike):
```rust
use wasm_bindgen::prelude::*;

mod types;
pub use types::ParseResult;

/// Stub: replaced after PDF crate spike confirms the winning crate.
/// Returns a test parse result so the WASM build can be validated independently.
#[wasm_bindgen]
pub fn parse_pdf(_input: &[u8]) -> Result<JsValue, JsError> {
    let result = ParseResult {
        words: vec!["stub".to_string(), "pdf".to_string(), "result".to_string()],
        title: Some("Stub PDF".to_string()),
    };
    serde_wasm_bindgen::to_value(&result)
        .map_err(|e| JsError::new(&format!("Serialization failed: {e}")))
}
```

8. Verify the Rust workspace compiles for wasm32:
```bash
cd rsvp-parser && cargo check --target wasm32-unknown-unknown 2>&1
```
(This uses the stub lib.rs without pdf-extract — should succeed cleanly.)
  </action>
  <verify>
Run: `cd /Users/nousunio/Repos/Learnings/claude-code/text-to-voice/rsvp-parser && cargo check --target wasm32-unknown-unknown`

Expected: No errors. Warnings about unused imports/functions are acceptable at this stub stage.

Also verify: `cat rsvp-parser/Cargo.toml | grep "opt-level"` shows `opt-level = "z"`.
  </verify>
  <done>
`cargo check --target wasm32-unknown-unknown` exits with code 0 (no errors). The workspace compiles the stub lib.rs for the WASM target. Release profile has opt-level="z", lto=true, codegen-units=1, panic="abort", strip=true. The .cargo/config.toml getrandom rustflag is in place.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` in project root starts Vite 7 dev server without errors
2. `npm list vite-plugin-wasm vite-plugin-top-level-await @tailwindcss/vite wasm-pack zustand` — all present
3. `vite.config.ts` contains `worker.plugins` (grep confirms)
4. `cargo check --target wasm32-unknown-unknown` in rsvp-parser/ exits 0
5. `rsvp-parser/.cargo/config.toml` contains `getrandom_backend`
6. `rsvp-parser/Cargo.toml` contains `panic = "abort"`
7. Directory structure exists: src/workers/, src/services/, src/lib/, src/components/EntryScreen/, src/components/TextPreview/, src/components/RSVPPlaceholder/, src/store/
</verification>

<success_criteria>
- Vite dev server starts clean (no plugin or import errors)
- Rust workspace cargo-checks for wasm32-unknown-unknown without errors
- All size optimization flags present in release profile
- WASM plugin config correct in both plugins and worker.plugins arrays
- getrandom rustflag in .cargo/config.toml (prevents spike from failing on known issue)
- Directory scaffold matches research-specified project structure
</success_criteria>

<output>
After completion, create `/Users/nousunio/Repos/Learnings/claude-code/text-to-voice/.planning/phases/01-wasm-pipeline-document-service/01-01-SUMMARY.md`
</output>
