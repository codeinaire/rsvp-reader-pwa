---
phase: 01-wasm-pipeline-document-service
plan: "02"
subsystem: infra
tags: [rust, wasm, wasm-pack, pdf-extract, lopdf, wasm-bindgen, wasm-opt]

# Dependency graph
requires:
  - phase: 01-01
    provides: "Rust WASM workspace with stub parse_pdf() and size-optimized Cargo release profile"
provides:
  - "pdf-extract 0.10.0 compiled to wasm32-unknown-unknown (bundler target) — 1018 KB bundle"
  - "pdf.rs with extract() function and empty-text detection for scanned PDF error path"
  - "Updated lib.rs using real pdf module (not Plan 01 stub)"
  - "SPIKE-DECISION.md documenting pdf-extract choice, 1018 KB bundle size, and wasm-opt fix"
  - "Compiled WASM pkg/ at rsvp-parser/crates/rsvp-parser/pkg/"
affects:
  - 01-03-PLAN  # DocumentService WASM worker uses the compiled pkg/ and parse_pdf() API
  - 01-04-PLAN  # UI wires up DocumentService

# Tech tracking
tech-stack:
  added:
    - "pdf-extract 0.10.0 (PDF text extraction, pure Rust)"
    - "lopdf 0.38.0 with wasm_js feature (getrandom 0.3.x WASM backend)"
  patterns:
    - "lopdf wasm_js feature required for getrandom 0.3.x WASM compilation"
    - "wasm-opt --enable-nontrapping-float-to-int required for pdf-extract i32.trunc_sat instructions"
    - "parse_pdf(input: &[u8]) -> Result<JsValue, JsError> is the WASM API surface for DocumentService"
    - "Empty-text guard: words.len() < 10 returns Err with user-friendly scanned PDF message"

key-files:
  created:
    - "rsvp-parser/crates/rsvp-parser/src/pdf.rs"
    - "rsvp-parser/crates/rsvp-parser/pkg/ (generated by wasm-pack)"
    - ".planning/phases/01-wasm-pipeline-document-service/SPIKE-DECISION.md"
  modified:
    - "rsvp-parser/crates/rsvp-parser/Cargo.toml"
    - "rsvp-parser/crates/rsvp-parser/src/lib.rs"
    - "rsvp-parser/Cargo.lock"

key-decisions:
  - "pdf-extract chosen over pdfium-render — compiled cleanly to wasm32 with 1018 KB bundle (under 2 MB)"
  - "lopdf wasm_js feature required: lopdf = { version = '0.38', features = ['wasm_js'] } resolves getrandom 0.3.x WASM compilation"
  - "wasm-opt flag --enable-nontrapping-float-to-int required: pdf-extract uses i32.trunc_sat_f64_s which older wasm-opt rejects without this flag"

patterns-established:
  - "Pattern: PDF extraction via pdf-extract returns ParseResult{words, title} through serde_wasm_bindgen"
  - "Pattern: Scanned PDF detection via words.len() < 10 guard with user-facing error message"

requirements-completed:
  - DOCF-01

# Metrics
duration: ~10min
completed: 2026-02-23
---

# Phase 01 Plan 02: PDF Crate Spike Summary

**pdf-extract 0.10.0 compiles cleanly to wasm32-unknown-unknown (bundler target) with lopdf wasm_js feature, producing a 1018 KB WASM bundle — pdfium-render fallback not needed**

## Performance

- **Duration:** ~10 min
- **Started:** 2026-02-23T05:09:41Z
- **Completed:** 2026-02-23T05:20:00Z (estimated, paused at checkpoint)
- **Tasks:** 2/2 complete (Task 2 checkpoint:human-verify approved 2026-02-23)
- **Files modified:** 4 modified, 3 created (including generated pkg/)

## Accomplishments

- pdf-extract 0.10.0 compiles to wasm32-unknown-unknown with correct lopdf wasm_js feature (resolves getrandom 0.3.x)
- wasm-pack build --target bundler --release succeeds; 1018 KB bundle is under the 2 MB target
- pdf.rs implemented with empty-text detection (fewer than 10 words = scanned PDF error)
- lib.rs updated from Plan 01 stub to real pdf module using parse_pdf() -> Result<JsValue, JsError>
- SPIKE-DECISION.md written with crate choice, bundle size measurement, and rationale

## Task Commits

Each task was committed atomically:

1. **Task 1: Attempt pdf-extract spike and implement pdf.rs with chosen crate** - `de95b41` (feat)

**Plan metadata:** (docs commit follows after checkpoint approval)

## Files Created/Modified

- `rsvp-parser/crates/rsvp-parser/Cargo.toml` - Added pdf feature as default, lopdf with wasm_js, nontrapping-float-to-int wasm-opt flag
- `rsvp-parser/crates/rsvp-parser/src/lib.rs` - Replaced stub with real pdf module using pdf::extract()
- `rsvp-parser/crates/rsvp-parser/src/pdf.rs` - Created: extract() with pdf-extract and empty-text guard
- `rsvp-parser/Cargo.lock` - Updated with new dependency lockfile entries
- `.planning/phases/01-wasm-pipeline-document-service/SPIKE-DECISION.md` - Created: crate decision, bundle size, build notes

## Decisions Made

- **pdf-extract over pdfium-render:** pdf-extract compiled cleanly on first attempt. pdfium-render would have required downloading a native pdfium.wasm binary (~40 MB) and placing it in public/. pdf-extract is pure Rust — simpler integration.
- **lopdf wasm_js Cargo feature:** getrandom 0.3.x (pulled in by lopdf) uses Cargo features for WASM backend selection (not the rustflags approach from 0.2.x). Enabling `features = ["wasm_js"]` directly on lopdf resolves the WASM compilation.
- **wasm-opt nontrapping-float-to-int flag:** The bundled wasm-opt binary in wasm-pack rejected i32.trunc_sat_f64_s instructions. Adding `--enable-nontrapping-float-to-int` to the wasm-opt flags enables this WASM feature and allows optimization to proceed.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] wasm-opt failed with i32.trunc_sat_f64_s feature validation error**
- **Found during:** Task 1 (Step 7: Run final build and measure)
- **Issue:** The bundled wasm-opt binary rejected `i32.trunc_sat_f64_s` (nontrapping float-to-int conversion) instructions with "unexpected false: all used features should be allowed". pdf-extract's float rounding code uses this WASM instruction.
- **Fix:** Added `--enable-nontrapping-float-to-int` to the wasm-opt flags in `[package.metadata.wasm-pack.profile.release]`
- **Files modified:** `rsvp-parser/crates/rsvp-parser/Cargo.toml`
- **Verification:** wasm-pack build completed successfully; pkg/rsvp_parser_bg.wasm exists at 1018 KB
- **Committed in:** `de95b41` (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (Rule 1 bug)
**Impact on plan:** Auto-fix essential for wasm-pack build completion. No scope creep. The wasm-opt flags are a build configuration detail; the fix adds the feature flag that matches what the compiled WASM actually uses.

## Issues Encountered

The getrandom 0.3.x issue (known pitfall from STATE.md) was handled preemptively by enabling `lopdf = { features = ["wasm_js"] }` in the initial Cargo.toml update. The wasm-opt flag issue was discovered and resolved automatically.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Plan 03 (WASM Worker + DocumentService): WASM pkg/ is ready at `rsvp-parser/crates/rsvp-parser/pkg/`
- The `parse_pdf(input: Uint8Array)` WASM export is the API the Worker will call
- No pdfium.wasm binary needed — pdf-extract is pure Rust
- Checkpoint approval required before Plan 03 begins

**Concerns:**
- None. pdf-extract compiled cleanly, bundle is within target.

## Self-Check: PASSED

- FOUND: 01-02-SUMMARY.md
- FOUND: SPIKE-DECISION.md
- FOUND: rsvp-parser/crates/rsvp-parser/src/pdf.rs
- FOUND: rsvp-parser/crates/rsvp-parser/pkg/rsvp_parser_bg.wasm (1018 KB)
- FOUND: de95b41 (Task 1 commit)
- FOUND: afb7478 (prior docs commit)
- FOUND: 19f1e43 (checkpoint approval commit)

---
*Phase: 01-wasm-pipeline-document-service*
*Completed: 2026-02-23 (checkpoint approved)*
