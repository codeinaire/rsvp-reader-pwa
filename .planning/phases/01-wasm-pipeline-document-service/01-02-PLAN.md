---
phase: 01-wasm-pipeline-document-service
plan: "02"
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - rsvp-parser/crates/rsvp-parser/Cargo.toml
  - rsvp-parser/crates/rsvp-parser/src/lib.rs
  - rsvp-parser/crates/rsvp-parser/src/pdf.rs
  - rsvp-parser/.cargo/config.toml
  - .planning/phases/01-wasm-pipeline-document-service/SPIKE-DECISION.md
autonomous: false
requirements:
  - DOCF-01

must_haves:
  truths:
    - "wasm-pack build completes without errors for the rsvp-parser crate"
    - "The compiled .wasm file is under 2 MB (measured, not estimated)"
    - "A real text-layer PDF is extracted to readable words by the WASM output"
    - "A scanned/image PDF returns an error (empty-text detection works)"
    - "The PDF crate choice (pdf-extract or pdfium-render) is documented in SPIKE-DECISION.md"
    - "Human has confirmed the spike result and the path forward"
  artifacts:
    - path: "rsvp-parser/crates/rsvp-parser/pkg/"
      provides: "Compiled WASM package (generated by wasm-pack)"
      contains: "rsvp_parser_bg.wasm"
    - path: ".planning/phases/01-wasm-pipeline-document-service/SPIKE-DECISION.md"
      provides: "Documented crate decision with rationale and bundle size measurement"
      contains: "Decision:"
    - path: "rsvp-parser/crates/rsvp-parser/src/pdf.rs"
      provides: "PDF extraction logic using chosen crate"
      contains: "pub fn extract"
  key_links:
    - from: "rsvp-parser/crates/rsvp-parser/src/lib.rs"
      to: "rsvp-parser/crates/rsvp-parser/src/pdf.rs"
      via: "mod pdf; pdf::extract(input) call"
      pattern: "pdf::extract"
    - from: "rsvp-parser/crates/rsvp-parser/src/pdf.rs"
      to: "WASM output"
      via: "empty text guard returns Err for scanned PDFs"
      pattern: "words.len\\(\\) < 10"
---

<objective>
Time-boxed spike (2-hour budget): attempt wasm-pack build with pdf-extract, measure bundle size, test extraction quality on real PDFs, document the crate decision. Ends with a human-verify checkpoint so the executor confirms the result before Plan 03 begins PDF implementation.

Purpose: The research identified MEDIUM-LOW confidence for pdf-extract WASM compilation (lopdf issue #408 still open as of Oct 2025). This spike answers the question definitively. Plan 03's PDF implementation depends on this decision.

Output: Compiled WASM pkg/ directory OR documented fallback decision. SPIKE-DECISION.md with the chosen crate, bundle size, and rationale. pdf.rs with extraction logic using the chosen crate.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-wasm-pipeline-document-service/01-RESEARCH.md
@.planning/phases/01-wasm-pipeline-document-service/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Attempt pdf-extract spike and implement pdf.rs with chosen crate</name>
  <files>
    rsvp-parser/crates/rsvp-parser/Cargo.toml
    rsvp-parser/crates/rsvp-parser/src/lib.rs
    rsvp-parser/crates/rsvp-parser/src/pdf.rs
    rsvp-parser/.cargo/config.toml
    .planning/phases/01-wasm-pipeline-document-service/SPIKE-DECISION.md
  </files>
  <action>
**Time-box: 2 hours. Follow the protocol exactly — no speculation, run the build.**

## Step 1: Enable pdf-extract in Cargo.toml

Update `rsvp-parser/crates/rsvp-parser/Cargo.toml` to enable pdf-extract (already declared optional in Plan 01 — just ensure it's in default features):

```toml
[features]
default = ["pdf"]
pdf = ["dep:pdf-extract"]
```

Verify the getrandom config is in place (from Plan 01):
```bash
cat rsvp-parser/.cargo/config.toml
# Should show: rustflags = ["--cfg", "getrandom_backend=\"wasm_js\""]
```

## Step 2: Attempt wasm-pack build

```bash
cd /Users/nousunio/Repos/Learnings/claude-code/text-to-voice
wasm-pack build rsvp-parser/crates/rsvp-parser --target bundler --release 2>&1
```

**CRITICAL: Use `--target bundler` (NOT `--target web`). This is a Vite project.**

### If build SUCCEEDS:
Proceed to Step 3.

### If build FAILS with getrandom error:
The .cargo/config.toml getrandom rustflag should prevent this. If it still fails, try adding to `rsvp-parser/crates/rsvp-parser/Cargo.toml`:
```toml
[dependencies]
getrandom = { version = "0.3", features = ["wasm_js"] }
```
Then retry. If it still fails, proceed to the pdfium-render fallback in Step 4.

### If build FAILS with simd-adler32 or other transitive dep error:
Proceed directly to pdfium-render fallback (Step 4).

## Step 3: Measure bundle size and test extraction quality

```bash
# Measure bundle size
ls -la rsvp-parser/crates/rsvp-parser/pkg/*.wasm
# Expected: under 2 MB after wasm-opt. If over 2 MB, log this finding.
```

Test extraction quality with a real PDF. Write a quick Node.js test script:

```bash
cat > /tmp/test-pdf-extract.mjs << 'EOF'
// Quick smoke test for WASM extraction
// Run with: node /tmp/test-pdf-extract.mjs
import { readFileSync } from 'fs'
import { join, dirname } from 'path'
import { fileURLToPath } from 'url'

// We test by loading the WASM in Node directly using the bundler target output
// This is a smoke test only — browser integration tested in checkpoint
const pkgDir = '/Users/nousunio/Repos/Learnings/claude-code/text-to-voice/rsvp-parser/crates/rsvp-parser/pkg'
try {
  const { parse_pdf } = await import(`${pkgDir}/rsvp_parser.js`)
  console.log('WASM loaded successfully')
  // If you have a test PDF, uncomment:
  // const pdfBytes = new Uint8Array(readFileSync('/path/to/test.pdf'))
  // const result = parse_pdf(pdfBytes)
  // console.log('Words extracted:', JSON.parse(result).words.length)
  console.log('Smoke test: WASM exports available')
} catch (e) {
  console.error('WASM load failed:', e.message)
}
EOF
node /tmp/test-pdf-extract.mjs
```

Document findings: words extracted count, any errors, extraction quality notes.

## Step 4: If pdf-extract fails — pdfium-render fallback

If pdf-extract does not compile cleanly OR produces empty results on a text-layer PDF:

1. Update `rsvp-parser/crates/rsvp-parser/Cargo.toml` — replace pdf-extract with pdfium-render:
```toml
[dependencies]
# ... existing wasm-bindgen, serde, serde-wasm-bindgen ...
pdfium-render = { version = "0.8", optional = true, default-features = false, features = ["wasm", "wasm_bindgen"] }

[features]
default = ["pdf"]
pdf = ["dep:pdfium-render"]
```

Note: pdfium-render requires a pre-compiled pdfium.wasm binary. For the spike, document this requirement — the binary must be placed in the public/ directory and loaded by the DocumentService. Full implementation guidance is in SPIKE-DECISION.md.

2. Attempt: `wasm-pack build rsvp-parser/crates/rsvp-parser --target bundler --release 2>&1`

3. Document the outcome regardless of which path was taken.

## Step 5: Implement pdf.rs with the chosen crate

Create `rsvp-parser/crates/rsvp-parser/src/pdf.rs` using whichever crate compiled successfully:

### If pdf-extract was chosen:
```rust
use crate::types::ParseResult;

/// Extract text from a PDF byte slice using pdf-extract.
/// Returns Err if the PDF has no text layer (scanned/image PDF).
pub fn extract(input: &[u8]) -> Result<ParseResult, Box<dyn std::error::Error>> {
    let text = pdf_extract::extract_text_from_mem(input)?;
    let words: Vec<String> = text
        .split_whitespace()
        .map(|w| w.to_string())
        .filter(|w| !w.is_empty())
        .collect();

    // Scanned PDF detection: fewer than 10 words in any real document strongly
    // suggests an image-only PDF with no text layer.
    if words.len() < 10 {
        return Err(
            "No readable text found. This PDF may be scanned or image-based. \
             Try a different PDF or paste the text instead."
                .into(),
        );
    }

    Ok(ParseResult { words, title: None })
}
```

### If pdfium-render was chosen:
```rust
use crate::types::ParseResult;

/// Extract text from a PDF using pdfium-render (browser WASM path).
/// Note: requires pdfium.wasm binary in public/ directory.
pub fn extract(input: &[u8]) -> Result<ParseResult, Box<dyn std::error::Error>> {
    use pdfium_render::prelude::*;
    let pdfium = Pdfium::new(
        Pdfium::bind_to_system_library()
            .map_err(|e| format!("pdfium init failed: {e}"))?,
    );
    let document = pdfium
        .load_pdf_from_byte_vec(input.to_vec(), None)
        .map_err(|e| format!("PDF load failed: {e}"))?;

    let mut words: Vec<String> = Vec::new();
    for page in document.pages().iter() {
        let text = page.text().map_err(|e| format!("Page text failed: {e}"))?;
        words.extend(
            text.all()
                .split_whitespace()
                .map(|w| w.to_string())
                .filter(|w| !w.is_empty()),
        );
    }

    if words.len() < 10 {
        return Err(
            "No readable text found. This PDF may be scanned or image-based. \
             Try a different PDF or paste the text instead."
                .into(),
        );
    }

    Ok(ParseResult { words, title: None })
}
```

## Step 6: Update lib.rs to use pdf module (replace stub from Plan 01)

```rust
use wasm_bindgen::prelude::*;

mod types;
mod pdf;
pub use types::ParseResult;

/// Extract text from a PDF byte slice.
/// Returns Err (visible to JS as a thrown exception) if the PDF has no text layer.
#[wasm_bindgen]
pub fn parse_pdf(input: &[u8]) -> Result<JsValue, JsError> {
    let result = pdf::extract(input)
        .map_err(|e| JsError::new(&e.to_string()))?;
    serde_wasm_bindgen::to_value(&result)
        .map_err(|e| JsError::new(&format!("Serialization failed: {e}")))
}
```

## Step 7: Run final build and measure

```bash
wasm-pack build rsvp-parser/crates/rsvp-parser --target bundler --release 2>&1
ls -la rsvp-parser/crates/rsvp-parser/pkg/*.wasm
```

## Step 8: Write SPIKE-DECISION.md

Create `.planning/phases/01-wasm-pipeline-document-service/SPIKE-DECISION.md`:

```markdown
# PDF Crate Spike Decision

**Date:** [today]
**Time spent:** [actual time]

## Decision: [pdf-extract | pdfium-render | PDF.js]

## Outcome

- Build result: [SUCCESS | FAILED with error X]
- Bundle size: [X KB] (target: under 2 MB)
- Extraction test: [words extracted from test PDF, or N/A if untested]
- Empty-text detection: [working | not tested]

## Rationale

[Why this crate was chosen. If fallback was needed, why pdf-extract failed.]

## Implications for Plan 03

[Any special setup required. E.g., if pdfium-render: need pdfium.wasm in public/]

## Build Command

```bash
wasm-pack build rsvp-parser/crates/rsvp-parser --target bundler --release
```
```
  </action>
  <verify>
1. `ls rsvp-parser/crates/rsvp-parser/pkg/*.wasm` — file exists
2. `ls -la rsvp-parser/crates/rsvp-parser/pkg/*.wasm` — size is under 2 MB (2,097,152 bytes)
3. `cat .planning/phases/01-wasm-pipeline-document-service/SPIKE-DECISION.md` — contains "Decision:" line
4. `cargo check --target wasm32-unknown-unknown` in rsvp-parser/ — still exits 0 with the full pdf.rs implementation
  </verify>
  <done>
WASM pkg/ directory exists with a .wasm file. SPIKE-DECISION.md documents the chosen crate, bundle size, and rationale. pdf.rs implements extraction with empty-text detection (fewer than 10 words = error). lib.rs uses the real pdf module (not the Plan 01 stub).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
PDF crate spike is complete. wasm-pack compiled the rsvp-parser crate to WASM. SPIKE-DECISION.md documents the chosen crate, measured bundle size, and rationale.
  </what-built>
  <how-to-verify>
1. Check the spike decision file:
   ```bash
   cat .planning/phases/01-wasm-pipeline-document-service/SPIKE-DECISION.md
   ```
   Confirm: chosen crate is documented, bundle size is listed, it's under 2 MB.

2. Confirm WASM compiled:
   ```bash
   ls -la rsvp-parser/crates/rsvp-parser/pkg/*.wasm
   ```
   File should exist and be under 2 MB.

3. Review the decision: does the chosen crate and its implications look acceptable?
   - If pdf-extract compiled: good to proceed to Plan 03 implementation.
   - If pdfium-render is needed: note that the pdfium.wasm binary will need to be downloaded and placed in public/. This is documented in SPIKE-DECISION.md.

4. If something went wrong (both crates failed, or bundle is massively oversized): describe the issue so the executor can adjust the approach.
  </how-to-verify>
  <resume-signal>Type "approved" to proceed to Plan 03 (WASM Worker + DocumentService implementation), or describe any issues that need addressing first.</resume-signal>
</task>

</tasks>

<verification>
1. `ls rsvp-parser/crates/rsvp-parser/pkg/` lists rsvp_parser_bg.wasm
2. SPIKE-DECISION.md exists and has Decision, bundle size, and rationale sections
3. `cargo check --target wasm32-unknown-unknown` succeeds with the full pdf.rs
4. Human has read and approved the spike result
</verification>

<success_criteria>
- WASM compiles cleanly (one of the two crate paths works)
- Bundle size measured and documented (target: under 2 MB)
- SPIKE-DECISION.md written with crate choice and rationale
- pdf.rs implements empty-text detection for scanned PDF error path
- Human has confirmed the decision and given "approved" signal
</success_criteria>

<output>
After completion, create `/Users/nousunio/Repos/Learnings/claude-code/text-to-voice/.planning/phases/01-wasm-pipeline-document-service/01-02-SUMMARY.md`
</output>
