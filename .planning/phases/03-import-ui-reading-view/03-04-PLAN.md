---
phase: 03-import-ui-reading-view
plan: 04
type: execute
wave: 3
depends_on: [03-02, 03-03]
files_modified:
  - src/components/RSVPReader/RSVPReader.tsx
  - src/components/RSVPReader/ORPDisplay.tsx
autonomous: true
requirements: [VIEW-01, VIEW-02, VIEW-04]

must_haves:
  truths:
    - "The /read screen splits into two zones: RSVP zone (sticky, ~40dvh) above and text panel (scrollable, flex-1) below with a visible divider"
    - "The RSVP zone stays fixed at the top of the viewport while the text panel scrolls independently"
    - "ORPDisplay renders with rsvpFontSize from Zustand store (not hardcoded 4.5rem)"
    - "PlaybackControls appears inside the sticky RSVP zone (no separate wrapping container below it)"
    - "The dual-view layout uses h-dvh on the outer container to avoid mobile browser chrome overlap"
  artifacts:
    - path: "src/components/RSVPReader/RSVPReader.tsx"
      provides: "Dual-view layout: sticky RSVP zone (h-[40dvh]) + TextPanel (flex-1 overflow-y-auto)"
      contains: "h-dvh"
    - path: "src/components/RSVPReader/ORPDisplay.tsx"
      provides: "ORPDisplay accepting rsvpFontSize prop (or reading from store) replacing hardcoded 4.5rem"
      contains: "rsvpFontSize"
  key_links:
    - from: "src/components/RSVPReader/RSVPReader.tsx"
      to: "src/components/RSVPReader/TextPanel.tsx"
      via: "JSX render inside flex column container"
      pattern: "TextPanel"
    - from: "src/components/RSVPReader/ORPDisplay.tsx"
      to: "useRsvpStore rsvpFontSize"
      via: "fontSize style prop"
      pattern: "rsvpFontSize"
---

<objective>
Replace RSVPReader's single-column centered layout with the dual-view design: a sticky RSVP zone (ProgressBar + ORPDisplay + PlaybackControls) fixed at the top ~40dvh, a divider line, and TextPanel filling the remaining height with independent scroll. Also update ORPDisplay to read rsvpFontSize from the Zustand store instead of the hardcoded 4.5rem.

Purpose: Assembles all Phase 3 components into the final reading experience. All sub-components (TextPanel, FontSizePanel via PlaybackControls, ORPDisplay) are built in earlier plans — this plan wires them into the new layout.
Output: Rewritten RSVPReader.tsx with dual-view layout and updated ORPDisplay.tsx with dynamic font size.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-import-ui-reading-view/03-CONTEXT.md
@.planning/phases/03-import-ui-reading-view/03-RESEARCH.md
@src/components/RSVPReader/RSVPReader.tsx
@src/components/RSVPReader/ORPDisplay.tsx
@src/components/RSVPReader/TextPanel.tsx
@src/store/rsvp-store.ts
@.planning/phases/03-import-ui-reading-view/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ORPDisplay to use rsvpFontSize from Zustand store</name>
  <files>src/components/RSVPReader/ORPDisplay.tsx</files>
  <action>
Update ORPDisplay.tsx to read `rsvpFontSize` from the Zustand store instead of the hardcoded `fontSize: '4.5rem'`.

**Current hardcoded value in ORPDisplay.tsx:**
```tsx
style={{
  display: 'grid',
  gridTemplateColumns: '14ch 1ch 20ch',
  fontSize: '4.5rem',   // ← hardcoded, must become dynamic
  lineHeight: 1,
}}
```

**Change:** Import `useRsvpStore` and read `rsvpFontSize`:
```tsx
import { useRsvpStore } from '../../store/rsvp-store'

export function ORPDisplay({ word }: ORPDisplayProps) {
  const { left, focal, right } = computeOrp(word)
  const rsvpFontSize = useRsvpStore((s) => s.rsvpFontSize)

  return (
    <div
      className="font-mono flex items-center justify-center"
    >
      <div
        style={{
          display: 'grid',
          gridTemplateColumns: '14ch 1ch 20ch',
          fontSize: rsvpFontSize,   // number (px) from store; default 72
          lineHeight: 1,
        }}
        className="font-mono items-center"
      >
        <span className="text-right text-white select-none">{left}</span>
        <span className="text-red-500 select-none">{focal}</span>
        <span className="text-left text-white select-none">{right}</span>
      </div>
    </div>
  )
}
```

**Note on the outer div styling change:** Remove `bg-gray-900 rounded-2xl py-10 px-12` from ORPDisplay's outer div — in the new dual-view layout, the RSVP zone container in RSVPReader provides the background and padding. Having redundant nested dark panels creates an unnecessary double-card visual. The outer div should be clean (`className="font-mono flex items-center justify-center"` only).

If this visual change breaks anything unexpected (e.g. test snapshots), restore the background to ORPDisplay. But the research recommends removing the nested dark panel since the RSVP zone itself is styled with `bg-gray-950`.

**fontSize unit:** `rsvpFontSize` is stored as a number (72 = 72px). When set as `fontSize: 72`, React/CSS treats it as `72px`. This is correct behavior.
  </action>
  <verify>
    <automated>cd /workspace && nvm use 22 2>/dev/null; npm run build 2>&1 | tail -5</automated>
    <manual>Build exits 0. ORPDisplay.tsx contains rsvpFontSize from store, no hardcoded 4.5rem.</manual>
  </verify>
  <done>ORPDisplay.tsx reads rsvpFontSize from useRsvpStore. fontSize style uses the dynamic value (default 72 = 4.5rem equivalent). Build exits 0.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite RSVPReader with dual-view layout (sticky RSVP zone + TextPanel)</name>
  <files>src/components/RSVPReader/RSVPReader.tsx</files>
  <action>
Replace the existing single-column centered layout in RSVPReader.tsx with the dual-view design from CONTEXT.md and RESEARCH.md. Preserve ALL existing side effects (scheduler, keyboard shortcuts, visibilitychange) — only the return JSX and layout change.

**New return JSX:**
```tsx
return (
  <div className="flex flex-col h-dvh bg-gray-950 overflow-hidden">
    {/* RSVP zone — sticky top ~40% of viewport */}
    <div className="h-[40dvh] flex-shrink-0 sticky top-0 z-10 bg-gray-950
                    flex flex-col items-center justify-center gap-4 px-4">
      <ProgressBar />
      <ORPDisplay word={wordList[currentWordIndex] ?? ''} />
      <div className="w-full max-w-xl">
        <PlaybackControls />
      </div>
    </div>

    {/* Divider between RSVP zone and text panel */}
    <div className="border-t border-gray-800 flex-shrink-0" />

    {/* Text panel — fills remaining 60% of viewport, scrolls independently */}
    <TextPanel />
  </div>
)
```

**Import additions needed:**
- Add `import { TextPanel } from './TextPanel'` at the top of RSVPReader.tsx

**All existing useEffect hooks must be preserved unchanged:**
- Guard redirect (empty wordList → navigate('/'))
- Scheduler (performance.now() deadline, reads from refs)
- Keyboard shortcuts (Space, ArrowLeft, ArrowRight)
- Visibility auto-pause (visibilitychange)
- Ref sync effects (wpmRef, isPlayingRef, wordListRef, etc.)

**Layout explanation for executor:**
- `h-dvh` on outer container: dynamic viewport height — adapts to mobile browser chrome (address bar) unlike `h-screen` / `100vh`
- `sticky top-0 z-10` on RSVP zone: sticks to top of the outer flex container (NOT window-level fixed positioning), which is correct because the outer container is `overflow-hidden` — the scroll happens inside TextPanel's `overflow-y-auto`, not at the window level
- `flex-shrink-0` on RSVP zone: prevents the zone from compressing below 40dvh when the outer container height is constrained
- TextPanel has `flex-1 overflow-y-auto` internally (set in Plan 03 implementation) — it fills remaining height and scrolls independently
- `max-w-xl` on PlaybackControls wrapper preserves the existing controls layout width constraint

**Mobile behavior:** On mobile, the same layout applies — the RSVP zone takes top 40dvh and text panel fills remaining 60dvh. Text panel is independently scrollable on mobile with touch. No special mobile-only layout changes are needed.

**Verify the `sticky` mechanism works:** In a `flex flex-col h-dvh overflow-hidden` container, `position: sticky` on a flex child correctly sticks that child within the container. The scroll context is the outer container (which has `overflow-hidden`), not the window. Since TextPanel has its own `overflow-y-auto`, it scrolls within its own div — this is the correct pattern. Do NOT use `position: fixed` for the RSVP zone.
  </action>
  <verify>
    <automated>cd /workspace && nvm use 22 2>/dev/null; npm run build 2>&1 | tail -5 && npm test 2>&1 | tail -10</automated>
    <manual>
1. Run dev server: nvm use 22 && npm run dev
2. Import a PDF or paste text from EntryScreen
3. Navigate to /read — confirm RSVP zone is fixed at top, text panel scrolls below
4. Confirm font size gear icon is visible in PlaybackControls, clicking shows FontSizePanel
5. Confirm +/- font size buttons change the RSVP word and text panel sizes live
6. Confirm auto-scroll tracks the current word in the text panel
7. Confirm text panel dims while playing, brightens when paused
    </manual>
  </verify>
  <done>RSVPReader.tsx renders dual-view layout: sticky RSVP zone (h-[40dvh]) + divider + TextPanel (flex-1). All existing side effects preserved. TextPanel imported and rendered. Build and all tests pass.</done>
</task>

</tasks>

<verification>
Run: `cd /workspace && nvm use 22 2>/dev/null; npm run build && npm test`
Expected: Build exits 0, all tests pass.

Structural check:
- RSVPReader.tsx contains `h-dvh` (not h-screen)
- RSVPReader.tsx contains `h-[40dvh]` (RSVP zone height)
- RSVPReader.tsx imports TextPanel
- ORPDisplay.tsx contains `rsvpFontSize` (from store, not hardcoded)
</verification>

<success_criteria>
1. /read screen shows sticky RSVP zone (top ~40%) with ProgressBar, ORPDisplay at dynamic font size, and PlaybackControls (with gear icon) — never scrolls.
2. Text panel (bottom ~60%) shows all document words with current word highlighted in yellow, auto-scrolls to keep current word in view, dims to 50% opacity while playing.
3. Gear icon in PlaybackControls opens FontSizePanel; RSVP word and full text font sizes are independently adjustable and persist across refresh.
4. All Phase 2 functionality preserved: scheduler, keyboard shortcuts, visibility auto-pause, jump controls, WPM slider.
5. Build exits 0 and all tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/03-import-ui-reading-view/03-04-SUMMARY.md`
</output>
