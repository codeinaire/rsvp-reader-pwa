---
phase: 03-import-ui-reading-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/store/rsvp-store.ts
  - src/components/TextPreview/TextPreview.tsx
autonomous: true
requirements: [IMPT-03, VIEW-03, VIEW-04]

must_haves:
  truths:
    - "User sees scrollable text preview (~200-300 words) with a fade-at-bottom gradient before starting RSVP"
    - "TextPreview shows filename, word count, and estimated reading time in a metadata summary"
    - "Error path shows a persistent message (not auto-dismissing) with a 'Try another file' button navigating to /"
    - "Font size preferences (rsvpFontSize, textFontSize) survive page refresh via localStorage"
    - "File picker (Choose PDF) and drag-drop on EntryScreen remain fully functional for IMPT-03"
  artifacts:
    - path: "src/store/rsvp-store.ts"
      provides: "rsvpFontSize + textFontSize fields with setters and clamped actions"
      contains: "rsvpFontSize"
    - path: "src/components/TextPreview/TextPreview.tsx"
      provides: "Enhanced preview with metadata, fade gradient, error state, and Start Reading CTA"
      min_lines: 90
  key_links:
    - from: "src/store/rsvp-store.ts"
      to: "localStorage key 'rsvp-settings'"
      via: "Zustand persist partialize"
      pattern: "rsvpFontSize.*textFontSize"
    - from: "src/components/TextPreview/TextPreview.tsx"
      to: "useRsvpStore"
      via: "wpm selector for reading time estimate"
      pattern: "useRsvpStore.*wpm"
---

<objective>
Extend the Zustand store with font size state (foundation for VIEW-04) and enhance TextPreview to match the locked user decisions for VIEW-03. Also confirm IMPT-03 (file picker) is complete in the existing EntryScreen.

Purpose: The store extension unblocks Plan 03 (FontSizePanel + TextPanel). TextPreview enhancement makes the import confirmation screen production-quality before RSVP starts.
Output: Extended rsvp-store.ts with font size fields and an enhanced TextPreview component with metadata, scrollable fade preview, and persistent error handling.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-import-ui-reading-view/03-CONTEXT.md
@.planning/phases/03-import-ui-reading-view/03-RESEARCH.md
@src/store/rsvp-store.ts
@src/components/TextPreview/TextPreview.tsx
@src/components/EntryScreen/EntryScreen.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend rsvp-store.ts with font size state and persisted actions</name>
  <files>src/store/rsvp-store.ts</files>
  <action>
Add two new fields and their setters to the existing RsvpStore interface and implementation. Follow the established pattern exactly — wpm is the reference implementation.

**Fields to add to RsvpStore interface** (in the "Settings" section, below wpm):
```typescript
// Settings (Phase 3 — persisted to localStorage)
rsvpFontSize: number  // RSVP word font size in px; default 72 (matches existing 4.5rem in ORPDisplay)
textFontSize: number  // Full text panel font size in px; default 16 (text-base equivalent)

// Actions — Phase 3 font size
setRsvpFontSize: (size: number) => void
setTextFontSize: (size: number) => void
```

**Initial state values** (inside the `create` call, next to wpm):
```typescript
rsvpFontSize: 72,
textFontSize: 16,
```

**Action implementations** (clamp on write — never let font sizes go out of range):
```typescript
setRsvpFontSize: (size) => set({ rsvpFontSize: Math.max(48, Math.min(120, size)) }),
setTextFontSize: (size) => set({ textFontSize: Math.max(12, Math.min(32, size)) }),
```

**Extend partialize** to include the new fields alongside wpm:
```typescript
partialize: (state) => ({
  wpm: state.wpm,
  rsvpFontSize: state.rsvpFontSize,
  textFontSize: state.textFontSize,
}),
```

**Do NOT** add rsvpFontSize or textFontSize to `ephemeralDefaults` — they are persisted settings, not ephemeral state. The `reset()` action must continue to not reset font sizes (same as wpm).

**Do NOT** change the localStorage key (`name: 'rsvp-settings'`) — Zustand merge handles the new keys automatically for existing users who already have `wpm` stored.
  </action>
  <verify>
    <automated>cd /workspace && nvm use 22 2>/dev/null; npm run build 2>&1 | tail -5</automated>
    <manual>Confirm build output is clean (exit 0). TypeScript must not error on RsvpStore interface.</manual>
  </verify>
  <done>rsvp-store.ts exports RsvpStore with rsvpFontSize and textFontSize fields. Both setters clamp to their respective ranges. partialize includes all three persisted fields. Build passes with no TypeScript errors.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance TextPreview with metadata, fade gradient, persistent error state, and confirm IMPT-03</name>
  <files>src/components/TextPreview/TextPreview.tsx</files>
  <action>
Rewrite TextPreview.tsx to match the locked user decisions from CONTEXT.md. Keep the existing routing and navigation logic; replace the UI implementation.

**IMPT-03 confirmation:** The file picker (Choose PDF button) and drag-drop target already exist in EntryScreen.tsx and are fully functional. No changes needed there. TextPreview is the destination after file import — improving it completes the import confirmation flow for IMPT-03.

**New TextPreview structure:**

1. **Guard redirect** — unchanged: if wordList.length === 0, navigate to '/' with replace:true

2. **Header** — keep existing Back chevron + centered document title + spacer structure

3. **Metadata summary** — show four items in a styled card above the preview:
   - Filename: `documentTitle ?? 'Pasted text'`
   - Word count: `wordList.length.toLocaleString() + ' words'`
   - Estimated reading time: `Math.ceil(wordList.length / wpm)` minutes — display as `~N min read`; if < 1 minute display `< 1 min read`; read `wpm` from `useRsvpStore((s) => s.wpm)`
   - Page count: display `pageCount ?? '—'` — BUT since ParseResult does not include pageCount yet, read `documentTitle` only and skip page count display for now (display "—" with label "Pages" OR omit the row). Use Claude's discretion — omitting the Pages row entirely is acceptable and avoids a stub value.

   Style: `grid grid-cols-2 gap-3 p-4 bg-gray-50 dark:bg-gray-900 rounded-xl border border-gray-100 dark:border-gray-800`; each item is a `flex flex-col gap-0.5` with a `text-xs text-gray-400 uppercase tracking-wide` label and `text-sm font-medium text-gray-900 dark:text-white` value.

4. **"Start Reading" CTA** — keep as is (prominent blue button above preview, navigates to /read)

5. **Scrollable text preview with fade gradient** — replace the current static preview box:
   - Show first 250 words (not 200) joined with spaces
   - Container: `relative overflow-hidden rounded-xl max-h-48` (limits visible area)
   - Apply CSS fade gradient via `style` prop (both prefixed and unprefixed for Safari):
     ```
     maskImage: 'linear-gradient(to bottom, black 60%, transparent 100%)',
     WebkitMaskImage: 'linear-gradient(to bottom, black 60%, transparent 100%)',
     ```
   - Inner `<p>`: `text-sm leading-relaxed text-gray-700 dark:text-gray-300 p-4 bg-gray-50 dark:bg-gray-900`

6. **Error state** — the existing TextPreview has no error state. Add a persistent error display triggered if wordList.length < 10 (which should not happen given EntryScreen guards, but guard it here too). Show:
   ```
   <div className="flex flex-col items-center gap-4 py-12 text-center">
     <p className="text-sm text-red-600 dark:text-red-400">
       No readable text found. This PDF may be scanned or image-based.
     </p>
     <button onClick={() => navigate('/')} ...>Try another file</button>
   </div>
   ```
   Show this in place of the Start Reading button and preview. Do NOT auto-dismiss — this is a persistent error requiring user action.

7. **No page count from Rust** — The research notes that adding pageCount to ParseResult is optional and requires WASM stack changes. Do not add pageCount to ParseResult, worker-types.ts, parser-worker.ts, or document-service.ts in this task. The Pages row in metadata is either omitted or shows "—" as a static placeholder.
  </action>
  <verify>
    <automated>cd /workspace && nvm use 22 2>/dev/null; npm run build 2>&1 | tail -5</automated>
    <manual>Navigate to http://localhost:5173/, import a PDF or paste text, confirm: scrollable preview with fade at bottom, word count, reading time estimation, Start Reading button above preview.</manual>
  </verify>
  <done>TextPreview renders: metadata card (word count, reading time), "Start Reading" CTA, scrollable preview with CSS fade gradient. Error path shows persistent error message + "Try another file" button. Build exits 0.</done>
</task>

</tasks>

<verification>
Run: `cd /workspace && nvm use 22 2>/dev/null; npm run build`
Expected: Exit 0, no TypeScript errors.
Run: `cd /workspace && nvm use 22 2>/dev/null; npm test 2>&1 | tail -10`
Expected: All existing tests (orp.test.ts, scheduler.test.ts) pass — no regressions.
</verification>

<success_criteria>
1. rsvp-store.ts exports RsvpStore with rsvpFontSize (default 72, range 48-120, step 8) and textFontSize (default 16, range 12-32, step 4) — both in partialize, both clamped in setters.
2. TextPreview shows metadata (word count, estimated reading time at user's current WPM), scrollable preview with fade gradient, and persistent error state.
3. EntryScreen file picker and drag-drop (IMPT-03) continue to work — no changes made to EntryScreen.
4. TypeScript build passes with no new errors.
</success_criteria>

<output>
After completion, create `.planning/phases/03-import-ui-reading-view/03-01-SUMMARY.md`
</output>
